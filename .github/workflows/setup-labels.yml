name: Setup Repository Labels

on:
  workflow_dispatch:
    inputs:
      recreate_all:
        description: "Recreate all labels (deletes existing)"
        type: boolean
        default: false

# Enhanced permissions for label management
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  setup-labels:
    name: Create Repository Labels
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Remove existing labels (if requested)
        if: github.event.inputs.recreate_all == 'true'
        run: |
          echo "ğŸ—‘ï¸ Removing existing labels..."
          gh label list --json name --jq '.[].name' | while read label; do
            echo "Deleting: $label"
            gh label delete "$label" --confirm || echo "Failed to delete: $label"
          done

      - name: Create Labels
        run: |
          # Function to create or update label
          create_or_update_label() {
            local name="$1"
            local color="$2"
            local description="$3"
            
            if gh label list --search "$name" --limit 1 | grep -q "^$name"; then
              echo "ğŸ“ Updating label: $name"
              gh label edit "$name" --color "$color" --description "$description" || echo "âŒ Failed to update: $name"
            else
              echo "âœ¨ Creating label: $name"
              gh label create "$name" --color "$color" --description "$description" || echo "âŒ Failed to create: $name"
            fi
          }

          echo "ğŸš€ Setting up repository labels..."

          # ğŸš€ Features and Enhancements
          create_or_update_label "feature" "0052cc" "New feature or request"
          create_or_update_label "enhancement" "a2eeef" "Enhancement to existing functionality"

          # ğŸ› Bug Fixes
          create_or_update_label "bug" "d73a4a" "Something isn't working"

          # ğŸ¨ UI/UX
          create_or_update_label "ui" "e1bee7" "User interface improvements"
          create_or_update_label "design" "f48fb1" "Design and styling updates"

          # ğŸŒ Internationalization
          create_or_update_label "i18n" "7e57c2" "Internationalization and localization"

          # ğŸ—ï¸ Infrastructure & DevOps
          create_or_update_label "infrastructure" "1976d2" "CI/CD and infrastructure"
          create_or_update_label "deployment" "0d47a1" "Deployment-related changes"
          create_or_update_label "performance" "00897b" "Performance improvements"
          create_or_update_label "config" "607d8b" "Configuration changes"

          # ğŸ”„ Code Quality
          create_or_update_label "refactor" "ffb74d" "Code refactoring"
          create_or_update_label "quality-checks" "26c6da" "Quality checks and validation"

          # ğŸ”’ Security & Compliance
          create_or_update_label "security" "b71c1c" "Security improvements"
          create_or_update_label "compliance" "4a148c" "Compliance and ISMS-related"
          create_or_update_label "accessibility" "4caf50" "Accessibility improvements"

          # ğŸ“ Documentation
          create_or_update_label "documentation" "0075ca" "Documentation updates"

          # ğŸ“¦ Dependencies
          create_or_update_label "dependencies" "0366d6" "Dependency updates"

          # ğŸ¤– GitHub Copilot & AI
          create_or_update_label "copilot" "5319e7" "GitHub Copilot configuration"
          create_or_update_label "agents" "673ab7" "GitHub Copilot agents"
          create_or_update_label "skills" "9c27b0" "GitHub Copilot skills"

          # ğŸ“„ Content Types
          create_or_update_label "content-pages" "90caf9" "Main website pages"
          create_or_update_label "content-blog" "64b5f6" "Blog content"
          create_or_update_label "content-projects" "42a5f5" "Project showcase pages"
          create_or_update_label "content-isms" "2196f3" "ISMS policy pages"
          create_or_update_label "content-services" "1e88e5" "Services and industries"

          # ğŸ–¼ï¸ Assets
          create_or_update_label "assets" "795548" "Images, icons, and media files"

          # ğŸ¯ SEO & Analytics
          create_or_update_label "seo" "ff6f00" "SEO and sitemap changes"

          # ğŸ” Specific Areas
          create_or_update_label "area-homepage" "ffd54f" "Homepage changes"
          create_or_update_label "area-cia" "ffca28" "Citizen Intelligence Agency"
          create_or_update_label "area-blacktrigram" "ffc107" "Black Trigram game"
          create_or_update_label "area-compliance" "ffb300" "Compliance Manager"

          # ğŸ“Š Size Labels
          create_or_update_label "size-xs" "3cbf00" "Extra small change (1-10 files)"
          create_or_update_label "size-s" "5d9801" "Small change (11-30 files)"
          create_or_update_label "size-m" "7f7f00" "Medium change (31-100 files)"
          create_or_update_label "size-l" "a67c00" "Large change (101-500 files)"
          create_or_update_label "size-xl" "d04437" "Extra large change (500+ files)"

          # Priority labels
          create_or_update_label "priority-high" "d73027" "High priority"
          create_or_update_label "priority-medium" "fb9a99" "Medium priority"
          create_or_update_label "priority-low" "fee08b" "Low priority"

          # Workflow labels
          create_or_update_label "good first issue" "7057ff" "Good for newcomers"
          create_or_update_label "help wanted" "008672" "Extra attention is needed"
          create_or_update_label "wontfix" "ffffff" "This will not be worked on"
          create_or_update_label "duplicate" "cfd3d7" "This issue or pull request already exists"
          create_or_update_label "invalid" "e4e669" "This doesn't seem right"
          create_or_update_label "question" "d876e3" "Further information is requested"

          echo "âœ… Label setup complete!"

      - name: Verify Labels
        run: |
          echo "ğŸ“‹ Current repository labels:"
          gh label list --limit 100

      - name: Test Labeler Configuration
        run: |
          echo "ğŸ” Validating labeler configuration..."
          if [[ -f ".github/labeler.yml" ]]; then
            echo "âœ… Labeler configuration file exists"
            # Count labels in config
            label_count=$(grep -E "^[a-z].*:" .github/labeler.yml | wc -l)
            echo "ğŸ“Š Found $label_count label definitions in config"
          else
            echo "âŒ Labeler configuration file not found"
            exit 1
          fi

          # Verify key labels exist
          key_labels=("infrastructure" "documentation" "security" "compliance" "bug" "feature" "i18n" "ui")
          for label in "${key_labels[@]}"; do
            if gh label list --search "$label" --limit 1 | grep -q "^$label"; then
              echo "âœ… Key label exists: $label"
            else
              echo "âŒ Missing key label: $label"
            fi
          done

      - name: Summary
        run: |
          total_labels=$(gh label list --limit 100 | wc -l)
          echo "ğŸ‰ Setup complete!"
          echo "ğŸ“Š Total labels in repository: $total_labels"
          echo ""
          echo "ğŸ”— The labeler workflow should now work correctly."
          echo "ğŸ“ Labels will be automatically applied to PRs based on file changes."
          echo ""
          echo "ğŸ“– Key features:"
          echo "   - Automatic labeling based on changed files"
          echo "   - Multi-language support detection (i18n label)"
          echo "   - Size-based labels (xs, s, m, l, xl)"
          echo "   - Content-type specific labels"
          echo "   - Security and compliance tracking"
