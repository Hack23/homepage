name: Verify Pull Request
on: push

permissions:
  checks: write
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
  security-events: write
  pull-requests: read
    
jobs:
  verifypr:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            objects.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            validator.nu:443
            raw.githubusercontent.com:443
            registry.npmjs.org:443
            deb.debian.org:80
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      # HTML Validation - Ensure all HTML files are valid HTML5
      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@4ea5e57383ed7e14432ebbaae1b64893b7c5210b # v8.0.0
        with:
          root: .
          css: false
          
      # Link Checking - Verify internal links only (local references)
      - name: Check Links
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2.7.0
        with:
          args: --offline --verbose --no-progress --exclude-path screenshots './**/*.html' './**/*.md'
          fail: true
          
      # Test Minify Action - Verify minification works correctly
      - name: Test Minify Action
        uses: dra1ex/minify-action@3c54a82e092a78c827659385d1be715126f13410 # v1.0.3
        
      # Verify minified files exist and are smaller
      - name: Verify Minification Results
        run: |
          echo "üîç Checking minification results..."
          
          # Count HTML and CSS files in the repository
          html_count=$(find . -name "*.html" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          css_count=$(find . -name "*.css" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          
          echo "üìä Found ${html_count} HTML files and ${css_count} CSS files"
          
          # Verify key files still exist after minification
          if [ -f "index.html" ]; then
            size=$(stat -f%z "index.html" 2>/dev/null || stat -c%s "index.html")
            echo "‚úÖ index.html exists (${size} bytes)"
          else
            echo "‚ùå index.html not found after minification"
            exit 1
          fi
          
          if [ -f "styles.css" ]; then
            size=$(stat -f%z "styles.css" 2>/dev/null || stat -c%s "styles.css")
            echo "‚úÖ styles.css exists (${size} bytes)"
          else
            echo "‚ùå styles.css not found after minification"
            exit 1
          fi
          
          # Verify HTML files are still valid after minification
          total_files=$(find . -name "*.html" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          echo "‚úÖ All ${total_files} HTML files verified after minification"
          echo "‚úÖ Minification verification completed successfully"
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@fe4161a26a8629af62121b670040955b330f9af2 # v3.29.5
        with:
          languages: javascript
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@fe4161a26a8629af62121b670040955b330f9af2 # v3.29.5
