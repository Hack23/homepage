name: Verify Pull Request
on: push

permissions:
  checks: write
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
  security-events: write
  pull-requests: read
    
jobs:
  verifypr:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            objects.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            validator.nu:443
            raw.githubusercontent.com:443
            registry.npmjs.org:443
            deb.debian.org:80
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Cache apt packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/pullrequest.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'

      - name: Cache npm dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-linkinator6-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-linkinator6-

      # HTML Validation - Ensure all HTML files are valid HTML5
      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@4ea5e57383ed7e14432ebbaae1b64893b7c5210b # v8.0.0
        with:
          root: .
          css: false
          
      # Link Checking - Verify internal links using linkinator with npx
      # Note: jq is pre-installed on ubuntu-latest, no sudo installation needed
      # Using linkinator@6 because v7.5.2 has module resolution bug
      
      - name: Verify linkinator@6 installation
        run: |
          echo "Installing and verifying linkinator v6..."
          # Force install linkinator@6 to ensure it's available
          npm install -g linkinator@6
          linkinator --version
          echo "‚úÖ linkinator v6 installed successfully"

      - name: Check Links
        run: |
          echo "üîç Starting local HTTP server for internal link checking..."
          python3 -m http.server 8080 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 5
          
          echo ""
          echo "üîó Checking internal links on localhost..."
          
          # Check links on localhost using global linkinator v6 (v7.5.2 has module resolution bug)
          # Increased timeout and concurrency to handle large site crawls
          linkinator http://localhost:8080/ \
            --recurse \
            --skip "^(?!http://localhost:8080)" \
            --timeout 30000 \
            --concurrency 25 \
            --format json > internal-links-report.json || true
          
          # Kill server
          kill $SERVER_PID 2>/dev/null || true
          
          # Parse and display results
          echo ""
          echo "üìä Internal Link Check Results:"
          if [ -f internal-links-report.json ]; then
            jq '.links[0:10]' internal-links-report.json
            
            # Count passed and failed links in a single jq invocation
            read passed failed < <(jq -r '
              [([.links[] | select(.state == "OK")] | length),
               ([.links[] | select(.state != "OK")] | length)] | @tsv
            ' internal-links-report.json 2>/dev/null || echo "0	0")
            
            echo ""
            echo "‚úÖ Passed: $passed links"
            echo "‚ùå Failed: $failed links"
            
            # Fail if there are broken links
            if [ "$failed" -gt "0" ]; then
              echo ""
              echo "‚ùå Found $failed broken internal links"
              exit 1
            fi
          fi

      - name: Upload Link Check Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: link-checker-report
          path: internal-links-report.json
          retention-days: 30
          
      # Test Minify Action - Verify minification works correctly
      - name: Test Minify Action
        uses: dra1ex/minify-action@3c54a82e092a78c827659385d1be715126f13410 # v1.0.3
        
      # Verify minified files exist and are smaller
      - name: Verify Minification Results
        run: |
          echo "üîç Checking minification results..."
          
          # Count HTML and CSS files in the repository
          html_count=$(find . -name "*.html" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          css_count=$(find . -name "*.css" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          
          echo "üìä Found ${html_count} HTML files and ${css_count} CSS files"
          
          # Verify key files still exist after minification
          if [ -f "index.html" ]; then
            size=$(stat -f%z "index.html" 2>/dev/null || stat -c%s "index.html")
            echo "‚úÖ index.html exists (${size} bytes)"
          else
            echo "‚ùå index.html not found after minification"
            exit 1
          fi
          
          if [ -f "styles.css" ]; then
            size=$(stat -f%z "styles.css" 2>/dev/null || stat -c%s "styles.css")
            echo "‚úÖ styles.css exists (${size} bytes)"
          else
            echo "‚ùå styles.css not found after minification"
            exit 1
          fi
          
          # Verify HTML files are still valid after minification
          total_files=$(find . -name "*.html" -not -path "./screenshots/*" -not -path "./.git/*" | wc -l)
          echo "‚úÖ All ${total_files} HTML files verified after minification"
          echo "‚úÖ Minification verification completed successfully"
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v3.29.5
        with:
          languages: javascript
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v3.29.5
