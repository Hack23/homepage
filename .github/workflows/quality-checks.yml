name: Quality Checks

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  html-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'

      - name: Cache npm global packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-global-${{ hashFiles('**/package-lock.json') }}-htmlhint
          restore-keys: |
            ${{ runner.os }}-npm-global-

      - name: Install HTMLHint
        run: npm install -g htmlhint

      - name: Validate HTML
        run: |
          echo "ğŸ” Validating HTML files with HTMLHint..."
          echo ""
          
          # Run HTMLHint on all HTML files and capture results
          if htmlhint *.html > htmlhint-report.txt 2>&1; then
            echo "âœ… All HTML files passed validation"
            cat htmlhint-report.txt
          else
            echo "âš ï¸ HTML validation found issues:"
            cat htmlhint-report.txt
            echo ""
            echo "ğŸ“Š Validation completed with warnings/errors"
            # Don't fail the build on HTML validation issues initially
            # exit 1
          fi
          
      - name: Upload HTMLHint Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: htmlhint-report
          path: htmlhint-report.txt
          retention-days: 30

  link-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'

      - name: Cache npm global packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-global-${{ hashFiles('**/package-lock.json') }}-linkinator
          restore-keys: |
            ${{ runner.os }}-npm-global-

      - name: Cache apt packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/quality-checks.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install linkinator
        run: npm install -g linkinator

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check internal links (static files)
        run: |
          echo "ğŸ” Starting local HTTP server for internal link checking..."
          python3 -m http.server 8080 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 5
          
          echo ""
          echo "ğŸ”— Checking internal links on localhost..."
          
          # Check links on localhost
          linkinator http://localhost:8080/ \
            --recurse \
            --skip "^(?!http://localhost:8080)" \
            --format json > internal-links-report.json || true
          
          # Kill server
          kill $SERVER_PID 2>/dev/null || true
          
          # Parse and display results
          echo ""
          echo "ğŸ“Š Internal Link Check Results:"
          if [ -f internal-links-report.json ]; then
            jq '.links[0:10]' internal-links-report.json
            
            # Count passed and failed links in a single jq invocation
            read passed failed < <(jq -r '
              [([.links[] | select(.state == "OK")] | length),
               ([.links[] | select(.state != "OK")] | length)] | @tsv
            ' internal-links-report.json 2>/dev/null || echo "0	0")
            
            echo ""
            echo "âœ… Passed: $passed links"
            echo "âŒ Failed: $failed links"
          fi
          
      - name: Check external links (sample pages)
        run: |
          echo ""
          echo "ğŸŒ Checking external links on deployed site (sample check)..."
          echo "Note: Only checking main index page to avoid rate limiting"
          
          # Check external links on deployed site (less frequently)
          # Only check key pages to avoid rate limiting
          linkinator https://hack23.com/ \
            --skip "(fonts\.googleapis\.com|fonts\.gstatic\.com|github\.com)" \
            --timeout 30000 \
            --format json > external-links-report.json || true
          
          echo ""
          echo "ğŸ“Š External Link Check Results:"
          if [ -f external-links-report.json ]; then
            jq '.links[0:10]' external-links-report.json
            
            # Count passed and failed links in a single jq invocation
            read passed failed < <(jq -r '
              [([.links[] | select(.state == "OK")] | length),
               ([.links[] | select(.state != "OK")] | length)] | @tsv
            ' external-links-report.json 2>/dev/null || echo "0	0")
            
            echo ""
            echo "âœ… Passed: $passed links"
            echo "âŒ Failed: $failed links"
            echo ""
            echo "â„¹ï¸ Note: External link checking is limited to avoid rate limiting"
          fi

      - name: Upload Link Check Reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: link-checker-reports
          path: |
            internal-links-report.json
            external-links-report.json
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: [html-validation, link-checker]
    if: always()
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Quality Check Summary
        run: |
          echo "=========================================="
          echo "   Quality Checks Completed"
          echo "=========================================="
          echo ""
          echo "âœ… HTML validation completed"
          echo "âœ… Link checking completed"
          echo ""
          echo "ğŸ“Š Check artifacts for detailed reports:"
          echo "   - htmlhint-report"
          echo "   - link-checker-reports"
          echo ""
          echo "=========================================="
